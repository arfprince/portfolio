name: PR Deployment Bot

on:
  pull_request:
    types: [opened, synchronize, reopened]
  
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write
  actions: write

jobs:
  post-deployment-prompt:
    name: Post Deployment Options
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}
      
      - name: Fetch base branch
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}
      
      - name: Detect changed services
        id: detect
        run: |
          BASE_BRANCH="${{ github.event.pull_request.base.ref }}"
          CHANGED_SERVICES=""
          
          CHANGED_FILES=$(git diff --name-only origin/$BASE_BRANCH...HEAD)
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          echo "---"
          
          if echo "$CHANGED_FILES" | grep -q "^apps/ezystudio-api/"; then
              CHANGED_SERVICES="$CHANGED_SERVICES api"
              echo "‚úì API service has changes"
          fi
          
          if echo "$CHANGED_FILES" | grep -q "^apps/ezystudio-web/"; then
              CHANGED_SERVICES="$CHANGED_SERVICES web"
              echo "‚úì Web service has changes"
          fi
          
          if echo "$CHANGED_FILES" | grep -q "^apps/ezystudio-admin/"; then
              CHANGED_SERVICES="$CHANGED_SERVICES admin"
              echo "‚úì Admin service has changes"
          fi
          
          if echo "$CHANGED_FILES" | grep -q "^apps/ezystudio-worker/"; then
              CHANGED_SERVICES="$CHANGED_SERVICES worker"
              echo "‚úì Worker service has changes"
          fi
          
          CHANGED_SERVICES=$(echo "$CHANGED_SERVICES" | xargs)
          
          if [ -z "$CHANGED_SERVICES" ]; then
              echo "No service changes detected"
              echo "changed_services=none" >> $GITHUB_OUTPUT
          else
              echo "Services with changes: $CHANGED_SERVICES"
              echo "changed_services=$CHANGED_SERVICES" >> $GITHUB_OUTPUT
          fi
      
      - name: Post deployment comment
        uses: actions/github-script@v7
        with:
          script: |
            const changedServices = '${{ steps.detect.outputs.changed_services }}';
            
            const body = `## üöÄ Preview Deployment
            
            Hello @${{ github.event.pull_request.user.login }}! üëã
            
            I detected changes in your PR. Would you like to deploy a preview environment?
            
            ---
            
            ### üì¶ Services with Changes
            
            ${changedServices !== 'none' ? `**Changed services:** \`${changedServices}\`` : '‚ö†Ô∏è No service changes detected in standard paths.'}
            
            ---
            
            ### üéØ Deployment Commands
            
            Reply with one of these commands:
            
            | Command | Description |
            |---------|-------------|
            | \`/deploy all\` | Deploy all services |
            | \`/deploy api\` | Deploy only API service |
            | \`/deploy web\` | Deploy only Web service |
            | \`/deploy admin\` | Deploy only Admin service |
            | \`/deploy worker\` | Deploy only Worker service |
            | \`/deploy api web\` | Deploy multiple services |
            
            ---
            
            *ü§ñ I'm a bot! Reply with a command to start deployment.*`;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  process-deployment-command:
    name: Process Deployment Command
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/deploy')
    
    steps:
      - name: Parse command and respond
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment.body;
            let servicesToDeploy = [];
            let responseMessage = '';
            
            // Add eyes reaction to show we're processing
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'eyes'
            });
            
            // Parse the command
            if (comment.includes('/deploy all')) {
              servicesToDeploy = ['api', 'web', 'admin', 'worker'];
            } else if (comment.match(/\/deploy\s+[\w\s]+/)) {
              const match = comment.match(/\/deploy\s+([\w\s]+)/);
              if (match) {
                const requested = match[1].trim().split(/\s+/);
                const valid = ['api', 'web', 'admin', 'worker'];
                servicesToDeploy = requested.filter(s => valid.includes(s.toLowerCase()));
              }
            }
            
            if (servicesToDeploy.length === 0) {
              responseMessage = `## ‚ö†Ô∏è Invalid Command
              
              @${context.payload.comment.user.login}, I couldn't understand your command.
              
              **Valid commands:**
              - \`/deploy all\` - Deploy all services
              - \`/deploy api web\` - Deploy specific services
              
              Please try again.`;
            } else {
              responseMessage = `## üöÄ Deployment Starting!
              
              @${context.payload.comment.user.login}, I'm deploying the following services:
              
              **Services:** \`${servicesToDeploy.join(', ')}\`
              
              | Service | Status |
              |---------|--------|
              ${servicesToDeploy.map(s => `| ${s.toUpperCase()} | üîÑ Triggered |`).join('\n')}
              
              ---
              
              *Check the Actions tab for deployment progress.*`;
              
              // Add rocket reaction for success
              await github.rest.reactions.createForIssueComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: context.payload.comment.id,
                content: 'rocket'
              });
            }
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: responseMessage
            });

  show-interactive-selection:
    name: Show Interactive Selection
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/deploy-interactive')
    
    steps:
      - name: Post selection form
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## üéõÔ∏è Select Services to Deploy
            
            @${context.payload.comment.user.login}, copy and modify this command:
            
            \`\`\`
            /deploy api web admin worker
            \`\`\`
            
            Remove the services you DON'T want to deploy, then post the command.
            
            **Examples:**
            - \`/deploy api\` - Deploy only API
            - \`/deploy api web\` - Deploy API and Web
            - \`/deploy all\` - Deploy everything`;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });