name: Deploy Dispatcher

on:
  issue_comment:
    types: [created]

permissions:
  pull-requests: write
  actions: write
  issues: write
  contents: read

jobs:
  handle-command:
    if: |
      github.event.issue.pull_request && 
      startsWith(github.event.comment.body, '/deploy')
    runs-on: ubuntu-latest

    steps:
      - name: React to comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });

      - name: Get PR details
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            core.setOutput('branch', pr.data.head.ref);
            core.setOutput('sha', pr.data.head.sha);
            console.log(`Branch: ${pr.data.head.ref}`);
            console.log(`SHA: ${pr.data.head.sha}`);

      - name: Parse deploy command
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment.body;
            console.log(`Comment: ${comment}`);
            
            const parts = comment.trim().split(/\s+/).slice(1);
            console.log(`Parts: ${JSON.stringify(parts)}`);
            
            const requested = parts.map(s => s.toLowerCase());
            const allowedServices = ['api', 'auth', 'dashboard', 'payment'];
            const selected = requested.filter(s => allowedServices.includes(s));
            
            console.log(`Selected services: ${JSON.stringify(selected)}`);

            if (selected.length === 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `‚ö†Ô∏è No valid services found. Valid options: ${allowedServices.join(', ')}\n\nYour comment: \`${comment}\``
              });
              throw new Error('No valid services specified');
            }

            core.setOutput('services', selected.join(','));
            core.setOutput('services_json', JSON.stringify(selected));
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `üöÄ Deploying: **${selected.join(', ')}**\nBranch: \`${{ steps.pr.outputs.branch }}\``
            });

      - name: Trigger API deployment
        if: contains(steps.parse.outputs.services, 'api')
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            try {
              const response = await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'api.yml',
                ref: '${{ steps.pr.outputs.branch }}',
                inputs: {
                  pr_number: String(context.issue.number),
                  deploy_to_ecs: 'true'
                }
              });
              console.log('API workflow triggered successfully');
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `‚úÖ Triggered **api** deployment`
              });
            } catch (error) {
              console.error('Error triggering API workflow:', error);
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `‚ùå Failed to trigger **api** deployment: ${error.message}`
              });
              throw error;
            }

      - name: Trigger Auth deployment
        if: contains(steps.parse.outputs.services, 'auth')
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            try {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'auth.yml',
                ref: '${{ steps.pr.outputs.branch }}',
                inputs: {
                  pr_number: String(context.issue.number)
                }
              });
              console.log('Auth workflow triggered successfully');
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `‚úÖ Triggered **auth** deployment`
              });
            } catch (error) {
              console.error('Error triggering Auth workflow:', error);
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `‚ùå Failed to trigger **auth** deployment: ${error.message}`
              });
            }

      - name: Trigger Dashboard deployment
        if: contains(steps.parse.outputs.services, 'dashboard')
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            try {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'dashboard.yml',
                ref: '${{ steps.pr.outputs.branch }}',
                inputs: {
                  pr_number: String(context.issue.number)
                }
              });
              console.log('Dashboard workflow triggered successfully');
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `‚úÖ Triggered **dashboard** deployment`
              });
            } catch (error) {
              console.error('Error triggering Dashboard workflow:', error);
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `‚ùå Failed to trigger **dashboard** deployment: ${error.message}`
              });
            }

      - name: Trigger Payment deployment
        if: contains(steps.parse.outputs.services, 'payment')
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            try {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'payment.yml',
                ref: '${{ steps.pr.outputs.branch }}',
                inputs: {
                  pr_number: String(context.issue.number)
                }
              });
              console.log('Payment workflow triggered successfully');
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `‚úÖ Triggered **payment** deployment`
              });
            } catch (error) {
              console.error('Error triggering Payment workflow:', error);
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `‚ùå Failed to trigger **payment** deployment: ${error.message}`
              });
            }