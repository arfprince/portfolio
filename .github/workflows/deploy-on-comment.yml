name: Deploy Dispatcher

on:
  issue_comment:
    types: [created]

permissions:
  pull-requests: read
  actions: write
  issues: write
  contents: read

jobs:
  handle-command:
    if: startsWith(github.event.comment.body, '/deploy')
    runs-on: ubuntu-latest

    steps:
      - name: Parse deploy command
        id: parse
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const comment = context.payload.comment.body;
            const prNumber = context.payload.issue.number;
            const repo = context.repo;

            const parts = comment.split(/\s+/).slice(1); 
            const requested = parts.map(s => s.toLowerCase());

            const allowed = {
              api: "api.yml",
              auth: "auth.yml",
              dashboard: "dashboard.yml",
              payment: "payment.yml"
            };

            const selected = requested.filter(s => allowed[s]);

            if (selected.length === 0) {
              await github.rest.issues.createComment({
                owner: repo.owner,
                repo: repo.repo,
                issue_number: prNumber,
                body: `‚ö†Ô∏è No valid services found. Valid options: api, auth, dashboard, payment`
              });
              return;
            }

            core.setOutput("selected", JSON.stringify(selected));
            core.setOutput("pr", prNumber);

            await github.rest.issues.createComment({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: prNumber,
              body: `‚ñ∂Ô∏è Deploy command received: **${selected.join(', ')}**`
            });

      - name: Trigger workflows
        if: steps.parse.outputs.selected != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const selected = JSON.parse(core.getInput('selected') || '${{ steps.parse.outputs.selected }}');
            const prNumber = ${{ steps.parse.outputs.pr }};
            const repo = context.repo;

            // Get branch name of PR
            const pr = await github.rest.pulls.get({
              owner: repo.owner,
              repo: repo.repo,
              pull_number: prNumber
            });
            const branch = pr.data.head.ref;

            const workflowFiles = {
              api: "api.yml",
              auth: "auth.yml",
              dashboard: "dashboard.yml",
              payment: "payment.yml"
            };

            for (const s of selected) {
              const workflow = workflowFiles[s];

              await github.rest.actions.createWorkflowDispatch({
                owner: repo.owner,
                repo: repo.repo,
                workflow_id: workflow,
                ref: branch
              });

              await github.rest.issues.createComment({
                owner: repo.owner,
                repo: repo.repo,
                issue_number: prNumber,
                body: `üöÄ Triggered **${s}** deployment workflow (branch: \`${branch}\`).`
              });
            }
